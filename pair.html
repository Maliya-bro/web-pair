<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MALIYA-MD SESSION</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      :root {
        --glass-bg: rgba(0, 0, 0, 0.45);
        --glass-border: rgba(255, 255, 255, 0.14);
        --text: #ffffff;
        --muted: rgba(255, 255, 255, 0.75);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Arial, sans-serif;
      }

      body {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px;
        color: var(--text);
        background: url("https://github.com/Maliya-bro/MALIYA-MD/blob/main/images/web%20pair%20backgroun%20img.png?raw=true")
          no-repeat center center / cover;
      }

      /* --- High Glow 360° Rotating Border --- */
      @keyframes rotate-border {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      @keyframes hue-rotate {
        from { filter: hue-rotate(0deg); }
        to { filter: hue-rotate(360deg); }
      }

      .border-wrapper {
        position: relative;
        width: 100%;
        max-width: 450px;
        padding: 5px; /* border thickness */
        border-radius: 30px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;

        /* ✅ Glow වැඩි කරලා */
        box-shadow:
          0 0 35px rgba(0, 255, 140, 0.35),
          0 0 70px rgba(0, 255, 255, 0.18);

        animation: hue-rotate 4s linear infinite;
      }

      /* ✅ Glow line එක තවත් වැඩි */
      .border-wrapper::before {
        content: "";
        position: absolute;
        width: 210%;
        height: 210%;
        background: conic-gradient(
          #ff0000, #ffcc00, #25d366, #00ffff, #0055ff, #ff00ff, #ff0000
        );
        animation: rotate-border 2.2s linear infinite; /* a bit faster */
        z-index: 0;

        /* ✅ blur + glow වැඩි */
        filter: blur(9px);
        opacity: 0.95;
      }

      .border-wrapper::after {
        content: "";
        position: absolute;
        inset: 5px;
        background: #0a0a0a;
        border-radius: 25px;
        z-index: 1;
      }

      .container {
        width: 100%;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        position: relative;
        z-index: 2;
        overflow: hidden;
      }

      /* ===== Buttons Animations ===== */
      .btn {
        width: 100%;
        padding: 15px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        color: #fff;
        font-size: 15px;
        font-weight: 900;
        transition: transform .15s ease, box-shadow .25s ease, filter .2s ease, opacity .2s ease;
        position: relative;
        overflow: hidden;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: -40%;
        left: -60%;
        width: 50%;
        height: 180%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
        transform: rotate(20deg);
        transition: left .6s ease;
        pointer-events: none;
      }
      .btn:hover::before { left: 120%; }
      .btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
      .btn:active { transform: translateY(0px) scale(.985); }

      .btn .ripple {
        position: absolute;
        border-radius: 999px;
        transform: scale(0);
        animation: ripple .55s ease-out;
        background: rgba(255,255,255,.28);
        pointer-events: none;
      }
      @keyframes ripple { to { transform: scale(12); opacity: 0; } }

      .btn.loading { cursor: not-allowed; opacity: .92; }
      .btn.loading::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.16), rgba(255,255,255,.06));
        transform: translateX(-120%);
        animation: shimmer 1.1s linear infinite;
        pointer-events: none;
      }
      @keyframes shimmer { to { transform: translateX(120%); } }

      .generate-btn {
        background: linear-gradient(135deg, #25d366, #1ebe5d);
        margin-bottom: 15px;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      }

      .copy-btn {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: none;
        margin-top: 2px;
      }

      /* ✅ Song button outside the box */
      .song-float {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 9999;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .song-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(0,0,0,.45);
        color: #fff;
        font-weight: 900;
        cursor: pointer;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow:
          0 0 0 1px rgba(255,255,255,.06) inset,
          0 10px 25px rgba(0,0,0,.35);
        transition: transform .15s ease, box-shadow .25s ease, background .25s ease;
        position: relative;
        overflow: hidden;
      }
      .song-btn:hover { transform: translateY(-2px); background: rgba(0,0,0,.55); }
      .song-btn:active { transform: translateY(0px) scale(.985); }

      .song-btn.playing {
        box-shadow:
          0 0 0 2px rgba(37,211,102,.25),
          0 0 20px rgba(37,211,102,.25),
          0 12px 28px rgba(0,0,0,.35);
      }

      .song-btn .ripple { position: absolute; border-radius: 999px; transform: scale(0); animation: ripple .55s ease-out; background: rgba(255,255,255,.28); pointer-events: none; }

      /* --------------------------------- */
      .inner { padding: 25px; }
      .header { text-align: center; margin-bottom: 18px; }

      .logo {
        width: 75px; height: 75px; margin: 0 auto 12px;
        border-radius: 50%; background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--glass-border);
        display: grid; place-items: center;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      }
      .logo i { font-size: 32px; color: #fff; }

      .title { font-size: 26px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
      .subtitle { font-size: 13px; color: var(--muted); margin-top: 5px; }

      .toggle-container {
        display: flex; background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--glass-border);
        border-radius: 14px; padding: 4px; margin: 18px 0 14px; gap: 6px;
      }

      .toggle-option {
        flex: 1; padding: 10px; text-align: center; cursor: pointer;
        border-radius: 10px; font-size: 14px; font-weight: 800;
        color: var(--muted); transition: 0.25s ease;
        position: relative; overflow: hidden;
      }
      .toggle-option:hover { transform: translateY(-1px); color: #fff; }
      .toggle-option.active { background: rgba(255, 255, 255, 0.15); color: #fff; }

      .input-group { margin-bottom: 15px; }
      .input-label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--muted); }
      .input-field {
        width: 100%; padding: 14px; border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(0, 0, 0, 0.5); color: #fff; outline: none;
        transition: box-shadow .25s ease, border-color .25s ease, transform .15s ease;
      }
      .input-field:focus {
        border-color: rgba(37,211,102,.55);
        box-shadow: 0 0 0 3px rgba(37,211,102,.18);
        transform: translateY(-1px);
      }

      .code-display {
        background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px; padding: 15px; text-align: center;
        font-weight: 900; margin-bottom: 15px; min-height: 55px;
        display: flex; align-items: center; justify-content: center;
        position: relative; overflow: hidden;
      }

      .dots { display: inline-flex; gap: 6px; align-items: center; justify-content: center; }
      .dot {
        width: 8px; height: 8px; border-radius: 50%;
        background: rgba(255,255,255,.65);
        animation: bounce 0.9s infinite;
      }
      .dot:nth-child(2) { animation-delay: .12s; }
      .dot:nth-child(3) { animation-delay: .24s; }
      @keyframes bounce {
        0%, 80%, 100% { transform: translateY(0); opacity: .6; }
        40% { transform: translateY(-6px); opacity: 1; }
      }

      .qr-display { display: none; text-align: center; margin-bottom: 15px; }
      .qr-image { width: 100%; max-width: 250px; border-radius: 15px; border: 4px solid rgba(255, 255, 255, 0.1); }

      .scan-wrap {
        position: relative;
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
        border-radius: 16px;
        overflow: hidden;
      }
      .scan-line {
        position: absolute;
        left: 0; right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, rgba(0,255,255,.9), transparent);
        box-shadow: 0 0 14px rgba(0,255,255,.55);
        animation: scan 1.2s ease-in-out infinite;
        z-index: 2;
      }
      @keyframes scan {
        0% { top: 0%; opacity: .2; }
        50% { top: 92%; opacity: 1; }
        100% { top: 0%; opacity: .2; }
      }

      .powered { text-align: center; font-size: 11px; color: var(--muted); font-weight: 700; margin-top: 12px; }
      .footer { padding: 15px; text-align: center; font-size: 11px; color: rgba(255, 255, 255, 0.4); background: rgba(0,0,0,0.2); }
      .hidden { display: none; }

      .fade-in { animation: fadeIn .25s ease both; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>

  <body>
    <!-- ✅ Outside floating song Play/Pause button (one button) -->
    <div class="song-float">
      <button class="song-btn" id="songBtn" title="Play / Pause">
        <i class="fa-solid fa-music"></i>
        <span id="songText">Play Song</span>
      </button>
    </div>

    <div class="border-wrapper">
      <div class="container">
        <div class="inner">
          <div class="header">
            <div class="logo"><i class="fas fa-robot"></i></div>
            <div class="title">MALIYA-MD</div>
            <div class="subtitle">Secure Pairing Gateway</div>
          </div>

          <div class="toggle-container">
            <div class="toggle-option active" id="pairMode">Pair Code</div>
            <div class="toggle-option" id="qrMode">QR Code</div>
          </div>

          <div id="pairSection" class="fade-in">
            <div class="input-group">
              <label class="input-label">WhatsApp Number (+94xxx)</label>
              <input type="text" id="mobileNumber" class="input-field" placeholder="+947XXXXXXXX or 947XXXXXXXX">
            </div>
            <button class="btn generate-btn" id="submitBtn">Generate Code</button>
          </div>

          <div class="qr-display" id="qrSection">
            <div class="scan-wrap" id="scanWrap" style="display:none;">
              <div class="scan-line"></div>
              <img id="qrImage" class="qr-image" src="" alt="QR">
            </div>
            <p style="font-size: 11px; color: #888; margin-top: 10px;">Scan QR with your Phone</p>
          </div>

          <div class="code-display" id="codeDisplay">Enter your number above</div>
          <button class="btn copy-btn" id="copyBtn">Copy Connection Code</button>

          <div class="powered">POWERED BY MALINDU NADITH</div>
        </div>
        <div class="footer">© 2025 MALIYA-MD BOT</div>
      </div>
    </div>

    <audio id="bgSong" src="song.mp3" preload="auto" loop></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0-alpha.1/axios.min.js"></script>
    <script>
      const pairBtn = document.getElementById('pairMode');
      const qrBtn = document.getElementById('qrMode');
      const pairSection = document.getElementById('pairSection');
      const qrSection = document.getElementById('qrSection');
      const codeDisplay = document.getElementById('codeDisplay');
      const copyBtn = document.getElementById('copyBtn');
      const submitBtn = document.getElementById('submitBtn');
      const qrImage = document.getElementById('qrImage');
      const scanWrap = document.getElementById('scanWrap');

      // Song
      const bgSong = document.getElementById('bgSong');
      const songBtn = document.getElementById('songBtn');
      const songText = document.getElementById('songText');

      // helpers
      function setCode(textOrHtml, isHtml=false) {
        if(isHtml) codeDisplay.innerHTML = textOrHtml;
        else codeDisplay.innerText = textOrHtml;
        codeDisplay.classList.remove('fade-in');
        void codeDisplay.offsetWidth;
        codeDisplay.classList.add('fade-in');
      }

      function showDots(label="Generating") {
        setCode(`
          <span style="display:inline-flex; gap:10px; align-items:center; font-size:12px; font-weight:900;">
            <i class="fa-solid fa-bolt"></i> ${label}
            <span class="dots" aria-hidden="true">
              <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </span>
          </span>
        `, true);
      }

      function setBtnLoading(btn, loading=true, textWhenLoading="Please wait...") {
        if(loading){
          btn.classList.add('loading');
          btn.disabled = true;
          btn.dataset.oldText = btn.innerText;
          btn.innerText = textWhenLoading;
        } else {
          btn.classList.remove('loading');
          btn.disabled = false;
          if(btn.dataset.oldText) btn.innerText = btn.dataset.oldText;
        }
      }

      // Ripple for buttons & toggles
      function addRipple(e){
        const el = e.currentTarget;
        const r = document.createElement('span');
        r.className = 'ripple';
        const rect = el.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        r.style.width = r.style.height = size + 'px';
        r.style.left = (e.clientX - rect.left - size/2) + 'px';
        r.style.top  = (e.clientY - rect.top  - size/2) + 'px';
        el.appendChild(r);
        setTimeout(()=> r.remove(), 650);
      }

      // attach ripple
      document.querySelectorAll('button, .toggle-option').forEach(el=>{
        el.addEventListener('click', addRipple);
      });

      // Mode switch
      pairBtn.onclick = () => {
        pairBtn.classList.add('active');
        qrBtn.classList.remove('active');

        pairSection.classList.remove('hidden');
        pairSection.classList.add('fade-in');

        qrSection.style.display = 'none';
        scanWrap.style.display = 'none';
        qrImage.src = "";

        copyBtn.style.display = 'none';
        setCode("Enter your number above");
      };

      qrBtn.onclick = async () => {
        qrBtn.classList.add('active');
        pairBtn.classList.remove('active');

        pairSection.classList.add('hidden');
        qrSection.style.display = 'block';

        copyBtn.style.display = 'none';

        // QR generating animation + scan frame
        showDots("Generating QR");
        scanWrap.style.display = 'block';
        qrImage.src = "";

        try {
          const res = await axios('/qr');
          if(res.data && res.data.qr) {
            qrImage.src = res.data.qr;
            setCode("Scan the QR Code");
          } else {
            setCode("QR unavailable right now");
          }
        } catch (e) {
          setCode("Error loading QR");
        }
      };

      // Pair generate
      submitBtn.onclick = async () => {
        const num = document.getElementById('mobileNumber').value;
        if(!num) return;

        copyBtn.style.display = 'none';

        setBtnLoading(submitBtn, true, "Generating...");
        showDots("Generating Pair Code");

        try {
          const clean = num.replace(/[^0-9]/g, "");
          const res = await axios(`/pair?number=${clean}`);
          const code = (res.data && res.data.code) ? res.data.code : "Unavailable";

          setCode(`<span style="color:#00ff00; font-size:24px; text-shadow: 0 0 12px #00ff00;">${code}</span>`, true);

          copyBtn.style.display = 'block';
          copyBtn.classList.add('fade-in');
          copyBtn.onclick = async () => {
            try{
              await navigator.clipboard.writeText(code);
              copyBtn.innerText = "COPIED!";
              setTimeout(() => copyBtn.innerText = "Copy Connection Code", 2000);
            }catch(err){
              copyBtn.innerText = "Copy Failed";
              setTimeout(() => copyBtn.innerText = "Copy Connection Code", 2000);
            }
          };
        } catch (e) {
          setCode("Server Error");
        } finally {
          setBtnLoading(submitBtn, false);
        }
      };

      // ✅ Song Play/Pause (single button)
      let isPlaying = false;
      bgSong.volume = 0.85;

      async function playSong(){
        try{
          await bgSong.play(); // must be user click
          isPlaying = true;
          songText.innerText = "Pause Song";
          songBtn.classList.add('playing');
          songBtn.querySelector('i').className = "fa-solid fa-pause";
        }catch(e){
          songText.innerText = "Song Error";
          setTimeout(()=> songText.innerText = "Play Song", 2000);
        }
      }

      function pauseSong(){
        bgSong.pause();
        isPlaying = false;
        songText.innerText = "Play Song";
        songBtn.classList.remove('playing');
        songBtn.querySelector('i').className = "fa-solid fa-music";
      }

      songBtn.onclick = async () => {
        if(!isPlaying) await playSong();
        else pauseSong();
      };
    </script>
  </body>
</html>
